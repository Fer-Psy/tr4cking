{% extends 'layouts/base_tabler.html' %}

{% block title %}Incidencias - TR4CKING{% endblock %}
{% block title_content %}Gesti√≥n de Incidencias{% endblock %}

{% block content %}
<!-- Acciones -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="btn-group">
        <a href="?estado="
            class="btn {% if not estado_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">Todas</a>
        <a href="?estado=abierta"
            class="btn {% if estado_filter == 'abierta' %}btn-primary{% else %}btn-outline-primary{% endif %}">Abiertas</a>
        <a href="?estado=en_proceso"
            class="btn {% if estado_filter == 'en_proceso' %}btn-primary{% else %}btn-outline-primary{% endif %}">En
            Proceso</a>
        <a href="?estado=resuelta"
            class="btn {% if estado_filter == 'resuelta' %}btn-primary{% else %}btn-outline-primary{% endif %}">Resueltas</a>
    </div>
    <a href="{% url 'operations:incidencia_create' %}" class="btn btn-danger">
        <i class="bi bi-plus-lg me-1"></i> Reportar Incidencia
    </a>
</div>

<!-- Filtros adicionales -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <input type="hidden" name="estado" value="{{ estado_filter }}">
            <div class="col-md-4">
                <label class="form-label">Prioridad</label>
                <select name="prioridad" class="form-select">
                    <option value="">Todas</option>
                    {% for value, label in prioridades %}
                    <option value="{{ value }}" {% if prioridad_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Incidencias -->
<div class="card">
    <div class="list-group list-group-flush">
        {% for inc in incidencias %}
        <a href="{% url 'operations:incidencia_detail' inc.pk %}" class="list-group-item list-group-item-action">
            <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex gap-3">
                    <!-- Indicador de prioridad -->
                    <div class="flex-shrink-0">
                        <span class="badge rounded-pill 
                            {% if inc.prioridad == 'critica' %}bg-danger
                            {% elif inc.prioridad == 'alta' %}bg-orange
                            {% elif inc.prioridad == 'media' %}bg-yellow
                            {% else %}bg-secondary{% endif %}" style="width: 80px;">
                            {{ inc.get_prioridad_display }}
                        </span>
                    </div>

                    <div>
                        <h6 class="mb-1">
                            <span class="badge bg-secondary-lt me-2">{{ inc.get_tipo_display }}</span>
                            {% if inc.viaje %}
                            {{ inc.viaje.itinerario.nombre }}
                            {% else %}
                            Sin viaje asignado
                            {% endif %}
                        </h6>
                        <p class="mb-1 text-muted">{{ inc.descripcion|truncatechars:120 }}</p>
                        <small class="text-muted">
                            <i class="bi bi-person me-1"></i>{{
                            inc.reportador.get_full_name|default:inc.reportador.username }}
                            <i class="bi bi-clock ms-2 me-1"></i>{{ inc.fecha_reporte|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                </div>

                <div class="text-end">
                    <span class="badge 
                        {% if inc.estado == 'resuelta' %}bg-success
                        {% elif inc.estado == 'en_proceso' %}bg-info
                        {% elif inc.estado == 'cerrada' %}bg-secondary
                        {% else %}bg-warning{% endif %}">
                        {{ inc.get_estado_display }}
                    </span>
                    {% if inc.estado == 'resuelta' %}
                    <div class="small text-muted mt-1">
                        {{ inc.fecha_resolucion|date:"d/m/Y" }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </a>
        {% empty %}
        <div class="list-group-item text-center py-5 text-muted">
            <i class="bi bi-check-circle h1 text-success"></i>
            <p class="mb-0">No hay incidencias que mostrar</p>
        </div>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
    <div class="card-footer d-flex justify-content-center">
        <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                    href="?page={{ page_obj.previous_page_number }}&estado={{ estado_filter }}&prioridad={{ prioridad_filter }}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link"
                    href="?page={{ page_obj.next_page_number }}&estado={{ estado_filter }}&prioridad={{ prioridad_filter }}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}
